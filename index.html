<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Votazione Squadre </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { 
    font-family: sans-serif; 
    background:#0f172a; 
    color:#e5e7eb; 
    margin:0; 
    padding:2rem;
  }
  .container { 
    max-width: 600px; 
    margin: 0 auto; 
    padding: 1.5rem;
    background: #1e293b;
    border-radius: 8px;
  }
  hr { border-color: #334155; margin: 1.5rem 0; }
  select, button { padding:0.6rem; margin:0.25rem 0; border-radius:6px; border:none; font-size: 1rem; }
  select { background: #334155; color: #e5e7eb; }
  button { cursor:pointer; background:#22c55e; color:#022c22; font-weight:bold; transition: background-color 0.2s; }
  button:disabled { background:#6b7280; cursor: not-allowed; }
  #message { margin:0.8rem 0 0; font-weight: bold; min-height: 1.2rem; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
  th, td { padding: 0.75rem; text-align: left; border: 1px solid #334155; }
  thead th { background-color: #334155; }
  tr:nth-child(even) { background-color: #1f2937; }
</style>
</head>
<body>
<div class="container">
    <h1>Votazione Squadre)</h1>

    <div>
        <label for="teamSelect">Squadra:</label>
        <select id="teamSelect"></select>

        <label for="scoreSelect">Voto da 1 a 10:</label>
        <select id="scoreSelect"></select>

        <button id="voteBtn">Vota</button>
        <div id="message"></div>
    </div>

    <hr>

    <h2>Statistiche</h2>
    
    
    <table border="1">
        <thead>
            <tr><th>Squadra</th><th>Voti Totali</th></tr>
        </thead>
        <tbody id="statsBody"></tbody>
    </table>
    
    <canvas id="chart"></canvas>
</div>



<script>
// ⚠️ if you found this url, it controls all the app data, rejoice, now come to sviluppo sicuro to join us. lil hacker
const NPOINT_URL = "https://api.npoint.io/236e96a835b472f70f49"; 
const TEAMS = ["Squadra 1","Squadra 2","Squadra 3","Squadra 4","Squadra 5","Squadra 6","Squadra 7","Squadra 8"];

const teamSelect = document.getElementById("teamSelect");
const scoreSelect = document.getElementById("scoreSelect");
const voteBtn = document.getElementById("voteBtn");
const message = document.getElementById("message");
const statsBody = document.getElementById("statsBody");
const ctx = document.getElementById("chart").getContext("2d");

let votesData = {}; 
let chart; 
let votedTeams = JSON.parse(localStorage.getItem("votedTeams")) || [];

function populateSelects() {
    teamSelect.innerHTML = "";
    TEAMS.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        if (votedTeams.includes(t)) {
            opt.disabled = true;
            opt.textContent += " (già votata)";
        }
        teamSelect.appendChild(opt);
    });

    scoreSelect.innerHTML = "";
    for (let i = 1; i <= 10; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i;
        scoreSelect.appendChild(opt);
    }
}

async function fetchVotes() {
    try {
        const res = await fetch(NPOINT_URL);
        if (!res.ok) throw new Error("HTTP error " + res.status);
        const data = await res.json();
        
        // Ensure all teams exist
        TEAMS.forEach(t => {
            if (!data[t] || typeof data[t].votes !== 'number') data[t] = { votes: 0 };
        });

        votesData = data;
        return true;

    } catch (e) {
        console.warn("Fetch failed, using fallback data:", e);

        // Fallback JSON if fetch fails
        const fallbackData = {
            "Squadra 1": { "votes": 1 },
            "Squadra 2": { "votes": 0 },
            "Squadra 3": { "votes": 0 },
            "Squadra 4": { "votes": 0 },
            "Squadra 5": { "votes": 0 },
            "Squadra 6": { "votes": 0 },
            "Squadra 7": { "votes": 10 },
            "Squadra 8": { "votes": 0 }
        };

        votesData = fallbackData;
        message.textContent = "⚠️ Non è stato possibile caricare i dati dal server, stai visualizzando valori di fallback.";
        return true; // still return true so UI renders
    }
}


function renderStats() {
    statsBody.innerHTML = "";
    const labels = [], data = [];
    TEAMS.forEach(t => {
        labels.push(t);
        data.push(votesData[t].votes);
        const row = document.createElement("tr");
        row.innerHTML = `<td>${t}</td><td>${votesData[t].votes}</td>`;
        statsBody.appendChild(row);
    });

    if(chart){
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
    } else {
        chart = new Chart(ctx,{
            type:"bar",
            data:{ labels, datasets:[{ label:"Voti Totali", data, backgroundColor:"#22c55e" }] },
            options:{ 
                responsive:true, 
                scales:{ 
                    y:{ beginAtZero:true, ticks:{ color:'#e5e7eb' }, grid:{ color:'#374151' } },
                    x:{ ticks:{ color:'#e5e7eb' }, grid:{ color:'#374151' } }
                },
                plugins:{ legend:{ labels:{ color:'#e5e7eb' } } }
            }
        });
    }
}

// ZERO CONCURRENCY MANAGEMNT, THANKS TO IA FOR THIS
async function sendVote(team, additionalVotes) {
    try {
        // Fetch voti correnti
        const res = await fetch(NPOINT_URL);
        if (!res.ok) throw new Error("HTTP error " + res.status);
        const currentData = await res.json();

        // Somma il nuovo voto
        if (!currentData[team] || typeof currentData[team].votes !== "number") {
            currentData[team] = { votes: 0 };
        }
        currentData[team].votes += additionalVotes;

        // Invia la nuova somma
        const patchRes = await fetch(NPOINT_URL, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentData)
        });

        if (!patchRes.ok) throw new Error("PATCH fallita: " + patchRes.status);
        return currentData; // ritorna dati aggiornati

    } catch (e) {
        console.warn("Impossibile inviare i dati al server:", e);
        message.textContent = "⚠️ Non è stato possibile inviare il voto al server, registrato solo localmente.";
        // aggiorna solo localmente
        votesData[team].votes += additionalVotes;
        return votesData;
    }
}

voteBtn.addEventListener("click", async () => {
    const team = teamSelect.value;
    const score = parseInt(scoreSelect.value, 10);
    if (!team || isNaN(score)) return;

    voteBtn.disabled = true;
    message.textContent = "⏳ Invio del voto in corso...";

    // Invio PATCH + fetch dei voti correnti
    const updatedData = await sendVote(team, score);

    votesData = updatedData;

    if (!votedTeams.includes(team)) {
        votedTeams.push(team);
        localStorage.setItem("votedTeams", JSON.stringify(votedTeams));
    }

    populateSelects();
    renderStats();

    message.textContent = "✅ Voto registrato!";
    voteBtn.disabled = false;
});

// Initialize
(async () => {
    const fetchSuccess = await fetchVotes();
    populateSelects();
    if(fetchSuccess) renderStats();
})();
</script>

</body>
</html>
